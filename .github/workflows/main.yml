on:
  push:
    branches:
      - "main"
  
jobs:

  enable-circleci:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v3
      - name: Create root directory
        run: |
          mkdir enable-circleci
          cd enable-circleci
      - name: Disable Github actions workflows
        shell: bash
        continue-on-error: true
        env:
         GH_TOKEN: ${{ secrets.CD_PAT }}
        run: |
          file="repo.txt"
          while read -r line; do
              echo "Processing repository $line"
              mkdir "$line"
              cd $line
              ## initinal git repository
              #git init
              #git remote add $line https://${{ secrets.CD_PAT }}@github.com/amornc/$line.git
              #git fetch $line
              #git checkout $line/main -- .github
              echo "echo Get workflows id"
              gh api \
              -H "Accept: application/vnd.github+json" \
              /repos/amornc/$line/actions/workflows | jq '.workflows | .[].id' >> $line-WorkflowId.txt
              echo "################################################################"
              echo "echo file $line-WorkflowId before insert string"
              cat $line-WorkflowId.txt
              echo "################################################################"
              echo "/repos/amornc/$line/actions/workflows/" >> $line-WorkflowPath.txt
              echo "echo file $line-WorkflowPath.txt"
              cat $line-WorkflowPath.txt
              echo "################################################################"
              ## replace workflow id
              sed -ie 's/^/\/repos\/amornc\/'$line'\/actions\/workflows\//' $line-WorkflowId.txt
              sed -ie 's/$/\/disable/' $line-WorkflowId.txt
              #sed -ie 's/$/\/enable/' $line-WorkflowId.txt
              echo "echo file $line-WorkflowId after insert string"
              cat $line-WorkflowId.txt
              echo "################################################################"
              echo "Disable github workflows"
              file=$line-WorkflowId.txt
              while read -r ID; do
                  gh api \
                   --method PUT \
                   -H "Accept: application/vnd.github+json" \
                   $ID
              done <$file
              echo "################################################################"
              #echo "echo Workflow Status"
              #echo "export getstatus=$(gh api \
              #-H "Accept: application/vnd.github+json" \
              #/repos/amornc/$line/actions/workflows | jq '.workflows | .[].id')"
              #gh api \
              # --method PUT \
              # -H "Accept: application/vnd.github+json" \
              # /repos/amornc/$line/actions/workflows/$getstatus
              #echo "################################################################"
              cd .. 
          done <$file
#      - name: list
#        shell: bash
#        run: |
#          #ls -lahR -I ".git"
#          #pwd
#          #find . -name '*.yaml' >> workflows.txt
#          #cat owner-repo.txt
#          file="repo.txt"
#          while read -r line; do
#              cd $line
#              cat $line-WorkflowPath.txt
#              cd ..
#          done <$file
#      - name: get workflows id
#        shell: bash
#        env:
#         GH_TOKEN: ${{ secrets.CD_PAT }}
#        run: |
#          file="repo.txt"
#          while read -r line; do
#              echo "$line"
#              gh api \
#              -H "Accept: application/vnd.github+json" \
#              /repos/amornc/$line/actions/workflows | jq '.workflows | .[].id' >> workflows-id.txt
#          done <$file 
#      - name: Upload workflows-id.txt
#        uses: actions/upload-artifact@v2
#        with:
#          name: workflows-id.txt
#          path: ./workflows-id.txt
#          if-no-files-found: error
#      - name: disable github workflows
#        shell: bash
#        env:
#         GH_TOKEN: ${{ secrets.CD_PAT }}
#        run: |
#          file="repo.txt"
#          while read -r line; do
#              echo "$line"
#              gh api \
#               --method PUT \
#               -H "Accept: application/vnd.github+json" \
#               /repos/amornc/$line/actions/workflows/33309412/disable
#          done <$file 
